{"version":3,"sources":["file:///E:/git/Cramped_Room_Of_Death/assets/base/State.ts"],"names":["State","animation","AnimationClip","Sprite","ResourceManager","ANIMATION_SPEED","constructor","fsm","path","wrapMode","speed","events","WrapMode","Normal","animationClip","init","promise","Instance","loadDir","waitingList","push","spriteFrames","track","ObjectTrack","TrackPath","toComponent","toProperty","frames","map","item","index","subframes","slice","length","channel","curve","assignSorted","addTrack","name","duration","event","updateEventDatas","run","animationComponent","defaultClip","play"],"mappings":"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","sourcesContent":["//需要知道animationClip\r\n//需要有播放动画的能力\r\n\r\nimport { animation, AnimationClip, Sprite, SpriteFrame, UITransform } from \"cc\";\r\nimport ResourceManager from \"../runtime/ResourceManager\";\r\nimport { TILE_WIDTH, TILE_HEIGHT } from \"../scripts/tile/TileManger\";\r\nimport { StateMachine } from \"./StateMachine\";\r\n\r\n//帧率1秒八帧\r\nexport const ANIMATION_SPEED = 1/8;\r\n\r\n//需要播放动画的组件\r\nexport default class State{\r\n    //动画相关\r\n    private animationClip: AnimationClip;\r\n\r\n    //fsm状态机状态\r\n    //path资源路径\r\n    //wrapMode播放类型\r\n    constructor(\r\n        private fsm: StateMachine, \r\n        private path: string, \r\n        private wrapMode: AnimationClip.WrapMode = AnimationClip.WrapMode.Normal,\r\n        private speed:number = ANIMATION_SPEED,\r\n        private events:any[] = []\r\n    ){\r\n        this.init();\r\n    }\r\n\r\n    async init(){\r\n        //加载图片资源\r\n        const promise = ResourceManager.Instance.loadDir(this.path);\r\n        this.fsm.waitingList.push(promise);\r\n        const spriteFrames = await promise;\r\n\r\n        //程序化编辑动画剪辑\r\n        this.animationClip = new AnimationClip();\r\n        const track = new animation.ObjectTrack();  //使用对象轨道\r\n\r\n        track.path = new animation.TrackPath().toComponent(Sprite).toProperty('spriteFrame');   //找sprite组件，找对应spriteFrame属性\r\n        //这种切分方式，map？？\r\n        //对象轨道只有一条动画曲线，[时间，变化属性]\r\n        const frames:Array<[number, SpriteFrame]> = spriteFrames.map((item:SpriteFrame, index:number)=>[ANIMATION_SPEED*index, item]);\r\n        //影分身是因为把外层的idle也加载进去了，这里去掉\r\n        const subframes = frames.slice(0, frames.length);\r\n        track.channel.curve.assignSorted(subframes);\r\n        //track.channel.curve.assignSorted(frames);\r\n\r\n        //轨道添加到动画剪辑以应用\r\n        this.animationClip.addTrack(track);\r\n        this.animationClip.name = this.path;\r\n        \r\n        this.animationClip.duration = frames.length * ANIMATION_SPEED;\r\n        this.animationClip.wrapMode = this.wrapMode;\r\n\r\n        for(const event of this.events){\r\n            this.animationClip.events.push(event);\r\n        }\r\n        this.animationClip.updateEventDatas();\r\n    }\r\n\r\n    run(){\r\n        if(this.fsm.animationComponent?.defaultClip?.name === this.animationClip.name){\r\n            return;\r\n        }\r\n        this.fsm.animationComponent.defaultClip = this.animationClip;\r\n        this.fsm.animationComponent.play();\r\n    }\r\n}"]}