{"version":3,"sources":["file:///E:/git/Cramped_Room_Of_Death/assets/scripts/woodenSkeleton/WoodenSkeletonManager.ts"],"names":["_decorator","DIRECTION_ENUM","ENTITY_STATE_ENUM","ENTITY_TYPE_ENUM","EVENT_ENUM","EventManager","EntityManager","WoodenSkeletonStateMachine","DataManager","ccclass","property","WoodenSkeletonManager","onDestroy","Instance","off","PLAYER_BORN","_onChangeDirection","PLAYER_MOVE_END","_onAttack","ATTACK_ENEMY","_onDead","init","fsm","addComponent","x","y","type","SKELETON_WOODEN","direction","TOP","state","IDLE","on","isInit","DEATH","player","playerX","playerY","disX","Math","abs","disY","RIGHT","LEFT","BOTTOM","playerState","AIRDEATH","ATTACK","emit","ATTACK_PLAYER","id"],"mappings":"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","sourcesContent":["import { _decorator } from 'cc';\r\nimport {  DIRECTION_ENUM, ENTITY_STATE_ENUM, ENTITY_TYPE_ENUM, EVENT_ENUM } from '../../enums';\r\nimport EventManager from '../../runtime/EventManager';\r\nimport { EntityManager } from '../../base/EntityManager';\r\nimport { WoodenSkeletonStateMachine } from './WoodenSkeletonStateMachine';\r\nimport DataManager from '../../runtime/DataManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n\r\n\r\n\r\n@ccclass('WoodenSkeletonManager')\r\nexport class WoodenSkeletonManager extends EntityManager {\r\n    \r\n    onDestroy(): void {\r\n        super.onDestroy();\r\n        EventManager.Instance.off(EVENT_ENUM.PLAYER_BORN, this._onChangeDirection);\r\n        EventManager.Instance.off(EVENT_ENUM.PLAYER_MOVE_END, this._onChangeDirection);\r\n        EventManager.Instance.off(EVENT_ENUM.PLAYER_MOVE_END, this._onAttack);\r\n        EventManager.Instance.off(EVENT_ENUM.ATTACK_ENEMY, this._onDead);    \r\n    }\r\n    \r\n    async init(){   \r\n        //添加状态机\r\n        this.fsm = this.addComponent(WoodenSkeletonStateMachine);\r\n        await this.fsm.init();\r\n        super.init({\r\n            x:5,\r\n            y:2,\r\n            type: ENTITY_TYPE_ENUM.SKELETON_WOODEN,\r\n            direction:DIRECTION_ENUM.TOP,\r\n            state:ENTITY_STATE_ENUM.IDLE\r\n        });\r\n        EventManager.Instance.on(EVENT_ENUM.PLAYER_BORN, this._onChangeDirection, this);\r\n        EventManager.Instance.on(EVENT_ENUM.PLAYER_MOVE_END, this._onChangeDirection, this);\r\n        EventManager.Instance.on(EVENT_ENUM.PLAYER_MOVE_END, this._onAttack, this);\r\n        EventManager.Instance.on(EVENT_ENUM.ATTACK_ENEMY, this._onDead, this);\r\n\r\n        //保证不管是敌人先生成or玩家先生成都会判断\r\n        this._onChangeDirection(true);\r\n    }\r\n\r\n    private _onChangeDirection(isInit:boolean = false){\r\n        if(this.state === ENTITY_STATE_ENUM.DEATH || !DataManager.Instance.player) return;\r\n\r\n        const {x:playerX, y:playerY} = DataManager.Instance.player;\r\n        const disX = Math.abs(this.x - playerX);\r\n        const disY = Math.abs(this.y - playerY);\r\n\r\n        if(disX === disY && !isInit){\r\n            return;\r\n        }\r\n\r\n        if(playerX >= this.x && playerY <= this.y){\r\n            this.direction = disY > disX ? DIRECTION_ENUM.TOP : DIRECTION_ENUM.RIGHT;\r\n        }\r\n        else if(playerX <= this.x && playerY <= this.y){\r\n            this.direction = disY > disX ? DIRECTION_ENUM.TOP : DIRECTION_ENUM.LEFT;\r\n        }\r\n        else if(playerX <= this.x && playerY >= this.y){\r\n            this.direction = disY > disX ? DIRECTION_ENUM.BOTTOM : DIRECTION_ENUM.LEFT;\r\n        }\r\n        else if(playerX >= this.x && playerY >= this.y){\r\n            this.direction = disY > disX ? DIRECTION_ENUM.BOTTOM : DIRECTION_ENUM.RIGHT;\r\n        }\r\n    }\r\n\r\n    private _onAttack(){\r\n        if(this.state === ENTITY_STATE_ENUM.DEATH || !DataManager.Instance.player) return;\r\n\r\n        const {x:playerX, y:playerY, state:playerState} = DataManager.Instance.player;\r\n        if(\r\n           ((this.x === playerX && Math.abs(this.y - playerY) <= 1)\r\n        || (this.y === playerY && Math.abs(this.x - playerX) <= 1))\r\n        && (playerState !== ENTITY_STATE_ENUM.DEATH)\r\n        && (playerState !== ENTITY_STATE_ENUM.AIRDEATH)\r\n        ){\r\n            this.state = ENTITY_STATE_ENUM.ATTACK;\r\n            EventManager.Instance.emit(EVENT_ENUM.ATTACK_PLAYER, ENTITY_STATE_ENUM.DEATH);\r\n        }\r\n        else{\r\n            this.state = ENTITY_STATE_ENUM.IDLE;\r\n        }\r\n         \r\n    }\r\n\r\n    private _onDead(id:string){\r\n        if(this.state === ENTITY_STATE_ENUM.DEATH){\r\n            return\r\n        }\r\n\r\n        if(this.id === id){\r\n            this.state = ENTITY_STATE_ENUM.DEATH;\r\n        }\r\n    }\r\n}\r\n\r\n\r\n"]}